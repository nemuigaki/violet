var width = 1;
var height = 1;
var windowPie = 1;
var isiOS = navigator.userAgent.indexOf("iPhone") > -1;
var isIpad = navigator.userAgent.indexOf("iPad") > -1;
var isAndroid = navigator.userAgent.indexOf("Android") > -1 || navigator.userAgent.indexOf("Adr") > -1;
var phone = isPhone();
var imgs = {
    starback: {url: "https://isluo.com/work/violet/assets/img/star-back1.jpg", dom: null, width: 1, height: 1, pie: 1},
    v: [{
        url: "https://isluo.com/work/violet/assets/v/1-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/2-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/3-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/4-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/5-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/6-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/7-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/8-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/9-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/10-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/11-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/12-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/13-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/14-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/15-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/16-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {url: "https://isluo.com/work/violet/assets/v/17-min.webp", dom: null, width: 1, height: 1, pie: 1}],
    vm: [{
        url: "https://isluo.com/work/violet/assets/v/1m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/2m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/3m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/4m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/5m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/6m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/7m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/8m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/9m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/10m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/11m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/12m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/13m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/14m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/15m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {
        url: "https://isluo.com/work/violet/assets/v/16m-min.webp",
        dom: null,
        width: 1,
        height: 1,
        pie: 1
    }, {url: "https://isluo.com/work/violet/assets/v/17m-min.webp", dom: null, width: 1, height: 1, pie: 1}],
    all: 18,
    down: 0
};
var $z = $("#z");
var canvas = document.getElementById("canvas1");
var ctx = canvas.getContext("2d");
var dpi = CanvalHD(ctx);
var drow_x = 1;
var stars = [];
var met = {};
var audio1 = document.getElementById("audio1");
var volumeTimer = null;
var dom_rotate = [0, 0];
var $dom = $("#letter");
var $letterInfo = $("#letter-info");
var scoler = 1;
var rotateTimer = null;
var hammerTest = null;
var dom_deg = 100;
$(function () {
    onInit()
});

function isPhone() {
    return navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)
}

function onInit() {
    FastClick.attach(document.body);
    initEvents();
    loadImg(imgs.starback, loadDown);
    var vs = phone ? imgs.vm : imgs.v;
    for (var i = 0;
         i < vs.length;
         i++) {
        loadImg(vs[i], loadDown)
    }
    initMet()
}

function initEvents() {
    $(window).on("resize", function () {
        width = canvas.offsetWidth;
        height = canvas.offsetHeight;
        canvas.width = width * dpi;
        canvas.height = height * dpi;
        windowPie = width / height;
        drow_x = Math.min(canvas.height * 1.15, canvas.width / 1.1);
        dom_deg = phone ? 20 : 70;
        initStart(phone ? 300 : 1800)
    }).resize();
    hammerTest = new Hammer(document.getElementById("letter-page"));
    hammerTest.get("pan").set({direction: Hammer.DIRECTION_ALL});
    hammerTest.get("pinch").set({enable: true});
    hammerTest.on("pan pinch", function (e) {
        switch (e.type) {
            case"pan":
                onPan(e);
                break;
            case"pinch":
                var s = e.scale;
                if (s > 1.5) {
                    s = 1.5
                } else {
                    if (s < 0.5) {
                        s = 0.5
                    }
                }
                $z.css({"transform": "scale(" + s + ")"})
        }
    });
    $("#letter-page").on("mousedown touchstart", function () {
        clearInterval(rotateTimer)
    }).on("mouseup touchend", function () {
        clearInterval(rotateTimer);
        rotateTimer = window.setInterval(autoRotate, 50)
    }).on("mousewheel", function (event, delta) {
        scoler += delta * 0.1;
        if (scoler > 1.5) {
            scoler = 1.5;
            return
        } else {
            if (scoler < 0.5) {
                scoler = 0.5
            }
        }
        $z.css({"transform": "scale(" + scoler + ")"})
    });
    $("#to_letter-page").on("click", function () {
        $(".pages[id!=letter-page]").fadeOut(300);
        $("#letter-page").fadeIn(300);
        $("#close").addClass("show");
        clearInterval(rotateTimer);
        rotateTimer = window.setInterval(autoRotate, 50)
    });
    $("#to_person-page").on("click", function () {
        clearInterval(rotateTimer);
        $(".pages[id!=person-page]").fadeOut(300);
        $("#person-page").fadeIn(300).scrollTop(0);
        $("#close").addClass("show")
    });
    $("#to_copyright-page").on("click", function () {
        clearInterval(rotateTimer);
        $(".pages[id!=copyright-page]").fadeOut(300);
        $("#copyright-page").fadeIn(300).scrollTop(0);
        $("#close").addClass("show")
    });
    $("#menu-music").on("click", function () {
        if ($("#music-info").data("music") === "close") {
            onMp3Play()
        } else {
            onMp3Pause()
        }
    });
    $("#close").on("click", function () {
        clearInterval(rotateTimer);
        $(".pages").fadeOut(300);
        $("#close").removeClass("show")
    });
    $("#loading-phone-in").on("click", function () {
        onMp3Play();
        $("#loading-phone-in").removeClass("show");
        start()
    });
    if (!phone) {
        $("#menu>li").addClass("pc")
    }
}

function loadImg(item, callback) {
    var img = document.createElement("img");
    img.onload = function () {
        item.dom = img;
        item.width = img.width;
        item.height = img.height;
        item.pie = img.width / img.height;
        callback()
    };
    img.onerror = function () {
        console.log("图片加载出错，请刷新页面")
    };
    img.src = item.url
}

function loadDown() {
    imgs.down++;
    $("#per").text((imgs.down / imgs.all * 100).toFixed(1) + "%");
    if (imgs.all === imgs.down) {
        show()
    }
}

function show() {
    $("#loading-box").addClass("hide");
    if (phone) {
        $("#loading-phone-in").addClass("show")
    } else {
        onMp3Play();
        start()
    }
}

function start() {
    $("#loading-box").fadeOut(3000);
    $("#menu").animate({opacity: "show", left: 0}, 600, function () {
        if (phone) {
            $("#menu").addClass("menu-phone")
        }
    });
    animate();
    setTimeout(function () {
        $("#logo-box").addClass("show")
    }, 600)
}

function initStart(num) {
    var grad = [];
    for (var k = 0;
         k < 11;
         k++) {
        for (var g = 0;
             g < k;
             g++) {
            grad.push(k)
        }
    }
    var obj;
    var max = Math.sqrt(Math.pow(canvas.width, 2) + Math.pow(canvas.height, 2));
    if (stars.length) {
        for (var j = 0;
             j < stars.length;
             j++) {
            obj = setStar(j, num);
            stars[j].r = random(max * 0.07 * grad[Math.round(random(0, grad.length))], max);
            stars[j].a = random(0, 0.5);
            stars[j].m = 0;
            stars[j].f = Math.random() > 0.7;
            stars[j].o = random(0.6, 1);
            stars[j].s = obj.s;
            stars[j].w = obj.w
        }
    } else {
        for (var i = 0;
             i < num;
             i++) {
            var c = document.createElement("canvas");
            c.width = 50;
            c.height = 50;
            var c_ctx = c.getContext("2d");
            c_ctx.fillStyle = getColor();
            c_ctx.shadowColor = getColor();
            c_ctx.shadowBlur = 21;
            c_ctx.beginPath();
            c_ctx.arc(25, 25, 2, 0, Math.PI * 2);
            c_ctx.fill();
            obj = setStar(i, num);
            var star = {
                pic: c,
                r: random(max * 0.07 * grad[Math.round(random(0, grad.length))], max),
                a: random(0, 0.5),
                m: 0,
                f: Math.random() > 0.7,
                o: random(0.6, 1),
                s: obj.s,
                w: obj.w
            };
            stars.push(star)
        }
    }
}

function setStar(i, num) {
    var obj = {};
    if (i < num / 9) {
        obj.s = 0.000115;
        obj.w = random(20, 22) * dpi
    } else {
        if (i < num / 8) {
            obj.s = 0.00012;
            obj.w = random(22, 23) * dpi
        } else {
            if (i < num / 7) {
                obj.s = 0.000125;
                obj.w = random(23, 24) * dpi
            } else {
                if (i < num / 6) {
                    obj.s = 0.00012;
                    obj.w = random(24, 25) * dpi
                } else {
                    if (i < num / 5) {
                        obj.s = 0.00013;
                        obj.w = random(25, 26) * dpi
                    } else {
                        if (i < num / 4) {
                            obj.s = 0.000135;
                            obj.w = random(26, 27) * dpi
                        } else {
                            if (i < num / 3) {
                                obj.s = 0.00014;
                                obj.w = random(27, 28) * dpi
                            } else {
                                if (i < num / 2) {
                                    obj.s = 0.000145;
                                    obj.w = random(28, 29) * dpi
                                } else {
                                    obj.s = 0.00015;
                                    obj.w = random(29, 30) * dpi
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    return obj
}

var c = document.createElement("canvas");
c.width = 300;
c.height = 5;
var c_ctx = c.getContext("2d");
var g = c_ctx.createRadialGradient(100, 1, 0, 200, 1, 125);
g.addColorStop(0, "rgb(255,255,255)");
g.addColorStop(0.2, "rgb(220,220,255)");
g.addColorStop(0.9, "transparent");
c_ctx.fillStyle = g;
c_ctx.beginPath();
c_ctx.fillRect(0, 0, 300, 3);
met.pic = c;

function initMet() {
    var temp_x = random(canvas.width * 0.3, canvas.width * 0.7);
    met.start = [temp_x, random(canvas.height * -0.25, canvas.height)];
    met.deg = random(-Math.PI / 180 * 15, Math.PI / 180 * 5);
    met.range = met.start[0] - random(canvas.width * 0.3, canvas.width * 0.8);
    met.leng = random(350 * dpi, 500 * dpi);
    met.pin = 0;
    met.sx = -Math.cos(met.deg) * 15 * dpi;
    met.sy = -Math.sin(met.deg) * 15 * dpi
}

function getColor() {
    return Math.random() < 0.8 ? "rgb(220,220,255)" : "rgb(" + Math.round(random(50, 255)) + ", " + Math.round(random(50, 255)) + ", " + Math.round(random(50, 255)) + ")"
}

function random(min, max) {
    return Math.random() * (max - min) + min
}

var personX = 0;
var personAdd = 0;
var meteor = false;
var dofor = 0;

function drow() {
    ctx.drawImage(imgs.starback.dom, 0, 0, imgs.starback.pie > windowPie ? canvas.height * imgs.starback.pie : canvas.width, imgs.starback.pie > windowPie ? canvas.height : canvas.width * imgs.starback.pie);
    for (dofor = 0;
         dofor < stars.length;
         dofor++) {
        var t = stars[dofor];
        var now = t.a - t.m;
        ctx.fillStyle = t.color;
        ctx.save();
        ctx.globalAlpha = t.o;
        ctx.drawImage(t.pic, canvas.width - Math.sin(now * Math.PI) * t.r, canvas.height - Math.cos(now * Math.PI) * t.r, t.w, t.w);
        ctx.restore();
        var rand = Math.random();
        if (t.f) {
            if (rand > 0.5 && t.o > 0.2) {
                t.o -= 0.1
            } else {
                if (rand < 0.5 && t.o < 1) {
                    t.o += 0.1
                }
            }
        }
        if (now < 0) {
            t.m = t.a - 0.5
        }
        t.m += t.s
    }
    if (meteor) {
        if (met.start[0] > met.range) {
            met.pin = met.pin < 1 ? met.pin + 0.01 : met.pin;
            met.start[0] += met.sx;
            met.start[1] += met.sy
        } else {
            if (met.pin > 0) {
                met.pin -= 0.02
            } else {
                meteor = false;
                initMet()
            }
        }
        ctx.save();
        ctx.translate(met.start[0], met.start[1]);
        ctx.rotate(met.deg);
        ctx.drawImage(met.pic, 0, 0, met.leng * met.pin, met.pin * 2);
        ctx.restore()
    }
    var p = phone ? imgs.vm : imgs.v;
    p[personX].dom && ctx.drawImage(p[personX].dom, canvas.width - drow_x, 0, canvas.height * p[personX].pie, canvas.height);
    personAdd++;
    if (personAdd === 4) {
        personX = personX > 15 ? 0 : personX + 1;
        personAdd = 0
    }
    if ((!phone) && (!meteor) && Math.random() > 0.999) {
        meteor = true
    }
}

function animate() {
    drow();
    requestAnimationFrame(animate)
}

var rotate_v = 0.2;

function autoRotate() {
    if (dom_rotate[1] > 20) {
        rotate_v = -0.2
    } else {
        if (dom_rotate[1] < -20) {
            rotate_v = 0.2
        }
    }
    dom_rotate[1] += rotate_v;
    makeLetter()
}

function onPan(e) {
    dom_rotate[0] -= e.deltaY / dom_deg;
    dom_rotate[1] += e.deltaX / dom_deg;
    if (dom_rotate[0] > 15) {
        dom_rotate[0] = 15
    } else {
        if (dom_rotate[0] < -15) {
            dom_rotate[0] = -15
        }
    }
    makeLetter();
    if (dom_rotate[1] > 90) {
        $letterInfo.html("后来，我终于明白什么是爱，<br/>可惜你早已远去，消失在人海")
    } else {
        $letterInfo.html("真希望你还活着.")
    }
}

function makeLetter() {
    var pi = Math.PI / 180;
    var op = Math.abs(Math.sin(pi * (dom_rotate[1] + 90))) / 2;
    var x = -Math.sin(pi * dom_rotate[1]) * 90;
    var y = Math.sin(pi * dom_rotate[0]) * 90;
    $dom.css("transform", "rotateX(" + dom_rotate[0] + "deg) rotateY(" + dom_rotate[1] + "deg)");
    $dom.css("box-shadow", x + "px " + y + "px " + "100px rgba(100,100,100," + op + ")")
}

function onMp3Play() {
    audio1.play();
    $("#menu-music").addClass("open");
    $("#music-info").data("music", "open").text("播放中");
    if (isiOS || isIpad) {
    } else {
        volumeUp()
    }
}

function onMp3Pause() {
    $("#menu-music").removeClass("open");
    $("#music-info").data("music", "close").text("已关闭");
    if (isiOS || isIpad) {
        audio1.pause()
    } else {
        volumeDown()
    }
}

function volumeUp() {
    clearTimeout(this.volumeTimer);
    if (audio1.volume + 0.1 <= 1) {
        audio1.volume += 0.1;
        this.volumeTimer = setTimeout(volumeUp, 150)
    }
}

function volumeDown() {
    clearTimeout(this.volumeTimer);
    if (audio1.volume - 0.1 >= 0) {
        audio1.volume -= 0.1;
        volumeTimer = setTimeout(volumeDown, 150)
    } else {
        audio1.pause()
    }
}

function CanvalHD(ctx) {
    var devicePixelRatio = window.devicePixelRatio || 1;
    var backingStorePixelRatio = ctx.webkitBackingStorePixelRatio || ctx.mozBackingStorePixelRatio || ctx.msBackingStorePixelRatio || ctx.oBackingStorePixelRatio || ctx.backingStorePixelRatio || 1;
    if (isAndroid || isIpad || !phone) {
        return devicePixelRatio / backingStorePixelRatio
    } else {
        return devicePixelRatio / backingStorePixelRatio * 2
    }
}

function makeImg(item, img) {
    console.log("宽高：" + img.width + "," + img.height);
    var c = document.createElement("canvas");
    c.width = img.width;
    c.height = img.height;
    var c_ctx = c.getContext("2d");
    c_ctx.drawImage(img, 0, 0, c.width, c.height);
    var imgdata = c_ctx.getImageData(0, 0, c.width, c.height);
    for (var i = 3;
         i < imgdata.data.length;
         i += 4) {
        var r = imgdata.data[i - 3];
        var g = imgdata.data[i - 2];
        var b = imgdata.data[i - 1];
        if (r > 180 && g < 80 && b < 80) {
            imgdata.data[i - 3] = imgdata.data[i - 2] = imgdata.data[i - 1] = imgdata.data[i] = 0
        } else {
            if (r + 54 > g + b && r > g && r > b) {
                imgdata.data[i - 3] = r - ((r - g) + (r - b)) / 2
            }
        }
    }
    c_ctx.putImageData(imgdata, 0, 0);
    item.dom = c
};
